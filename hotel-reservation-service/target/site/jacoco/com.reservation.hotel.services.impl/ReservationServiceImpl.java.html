<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReservationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hotel-registration-service</a> &gt; <a href="index.source.html" class="el_package">com.reservation.hotel.services.impl</a> &gt; <span class="el_source">ReservationServiceImpl.java</span></div><h1>ReservationServiceImpl.java</h1><pre class="source lang-java linenums">package com.reservation.hotel.services.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.payment.creditcard.model.PaymentStatusResponse;
import com.payment.creditcard.model.PaymentStatusRetrievalRequest;
import com.reservation.hotel.dto.ReservationRequest;
import com.reservation.hotel.dto.ReservationResponse;
import com.reservation.hotel.exception.*;
import com.reservation.hotel.feign.FeignCreditCardPaymentApiClient;
import com.reservation.hotel.model.PaymentMode;
import com.reservation.hotel.model.PaymentVerificationStatus;
import com.reservation.hotel.model.Reservation;
import com.reservation.hotel.model.ReservationStatus;
import com.reservation.hotel.repository.ReservationRepository;
import com.reservation.hotel.services.ReservationService;
import feign.FeignException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

<span class="fc" id="L27">@Slf4j</span>
@RequiredArgsConstructor
@Service
public class ReservationServiceImpl implements ReservationService {

    private final ReservationRepository reservationRepository;

    private final FeignCreditCardPaymentApiClient creditCardPaymentClient;

    private final ObjectMapper objectMapper;
    @Override
    @Transactional
    public ReservationResponse confirmReservation(ReservationRequest reservationRequest) {

<span class="fc" id="L41">        log.debug(&quot;Inside method confirmReservation: ReservationRequest and setting the reservation values&quot;);</span>

        // Check for existing reservation
<span class="fc" id="L44">        Optional&lt;Reservation&gt; existingReservation = reservationRepository</span>
<span class="fc" id="L45">                .findFirstByCustomerNameAndRoomNumberAndStartDateAndEndDateAndRoomSegmentAndPaymentMode(</span>
<span class="fc" id="L46">                        reservationRequest.getCustomerName(),</span>
<span class="fc" id="L47">                        reservationRequest.getRoomNumber(),</span>
<span class="fc" id="L48">                        reservationRequest.getStartDate(),</span>
<span class="fc" id="L49">                        reservationRequest.getEndDate(),</span>
<span class="fc" id="L50">                        reservationRequest.getRoomSegment(),</span>
<span class="fc" id="L51">                        reservationRequest.getPaymentMode()</span>
                );

<span class="fc bfc" id="L54" title="All 2 branches covered.">        if (existingReservation.isPresent()) {</span>
<span class="fc" id="L55">            log.info(&quot;Found existing reservation with ID: {}. Returning existing reservation (idempotent behavior)&quot;,</span>
<span class="fc" id="L56">                    existingReservation.get().getReservationId());</span>
<span class="fc" id="L57">            Reservation existing = existingReservation.get();</span>
<span class="fc" id="L58">            return new ReservationResponse(existing.getReservationId(), existing.getReservationStatus());</span>
        }

        // Used ObjectMapper to map ReservationRequest to Reservation
<span class="fc" id="L62">        Reservation reservation = objectMapper.convertValue(reservationRequest, Reservation.class);</span>
<span class="fc" id="L63">        BigDecimal totalAmount = reservationRequest.getRoomSegment().getPricePerDay();</span>
<span class="fc" id="L64">        reservation.setTotalAmount(totalAmount);</span>

        //Setting initial payment status as PENDING
<span class="fc" id="L67">        reservation.setReservationStatus(ReservationStatus.PENDING_PAYMENT);</span>

<span class="pc bpc" id="L69" title="1 of 4 branches missed.">        switch (reservationRequest.getPaymentMode()) {</span>

            case CASH -&gt; {
<span class="fc" id="L72">                log.debug(&quot;Setting reservation status as CONFIRMED, mode of payment is CASH&quot;);</span>
<span class="fc" id="L73">                reservation.setReservationStatus(ReservationStatus.CONFIRMED);</span>

<span class="fc" id="L75">            }</span>

            case CREDIT_CARD -&gt; {
<span class="fc" id="L78">                PaymentVerificationStatus status =</span>
<span class="fc" id="L79">                        verifyCreditCardPayment(reservationRequest.getPaymentReference());</span>

<span class="pc bpc" id="L81" title="1 of 4 branches missed.">                switch (status) {</span>
                    case CONFIRMED -&gt; {
<span class="fc" id="L83">                        log.debug(&quot;Full Payment done and confirmed by credit card&quot;);</span>
<span class="fc" id="L84">                        reservation.setReservationStatus(ReservationStatus.CONFIRMED);</span>
<span class="fc" id="L85">                    }</span>
                    case CANCELLED, PENDING -&gt; {
<span class="fc" id="L87">                        log.error(&quot;Credit Card Payment REJECTED&quot;);</span>
<span class="fc" id="L88">                        throw new PaymentNotConfirmedException(&quot;Payment is in pending state or cancelled&quot;);</span>
                    }
                    case NOT_FOUND -&gt; {
<span class="fc" id="L91">                        log.error(&quot;Credit Card Payment reference not found&quot;);</span>
<span class="fc" id="L92">                        throw new PaymentReferenceNotFoundException(&quot;Payment reference not found&quot;);</span>
                    }
                }
<span class="fc" id="L95">            }</span>

            case BANK_TRANSFER -&gt; {
                // keep PENDING_PAYMENT; will be confirmed via Kafka event
<span class="fc" id="L99">                log.debug(&quot;Keeping status as PENDING, it will be updated via Kafka&quot;);</span>
<span class="fc" id="L100">                reservation.setReservationStatus(ReservationStatus.PENDING_PAYMENT);</span>
            }
        }

<span class="fc" id="L104">        Reservation savedReservation = reservationRepository.save(reservation);</span>
<span class="fc" id="L105">        return new ReservationResponse(savedReservation.getReservationId(), savedReservation.getReservationStatus());</span>
    }

    @Transactional
    public void confirmBankTransferPayment(Long reservationId, BigDecimal amountReceived) {
        // log error if not found instead of throwing exception
<span class="fc" id="L111">        Optional&lt;Reservation&gt; reservation = reservationRepository.findById(reservationId);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (reservation.isEmpty()) {</span>
<span class="fc" id="L113">            log.error(&quot;Cannot process bank transfer payment: Reservation not found for id {}&quot;, reservationId);</span>
<span class="fc" id="L114">            return;</span>
        }

<span class="fc" id="L117">        Reservation reservationEvent = reservation.get();</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (reservationEvent.getPaymentMode() != PaymentMode.BANK_TRANSFER) {</span>
<span class="fc" id="L120">            log.error(&quot;Cannot process bank transfer payment: Reservation {} has payment mode {} instead of BANK_TRANSFER&quot;,</span>
<span class="fc" id="L121">                    reservationId, reservationEvent.getPaymentMode());</span>
<span class="fc" id="L122">            return;</span>
        }

        // Check if already cancelled - log warning
<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (reservationEvent.getReservationStatus() == ReservationStatus.CANCELLED) {</span>
<span class="fc" id="L127">            log.warn(&quot;Cannot process bank transfer payment: Reservation {} is already cancelled&quot;, reservationId);</span>
<span class="fc" id="L128">            return;</span>
        }

        // Check if already confirmed
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (reservationEvent.getReservationStatus() == ReservationStatus.CONFIRMED) {</span>
<span class="fc" id="L133">            log.info(&quot;Bank transfer payment received for reservation {} but it's already confirmed. Skipping update.&quot;, reservationId);</span>
<span class="fc" id="L134">            return;</span>
        }

<span class="fc" id="L137">        BigDecimal expectedAmount = reservationEvent.getTotalAmount();</span>
        //For partial payments keep the status pending
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (amountReceived.compareTo(expectedAmount) &lt; 0) {</span>
<span class="fc" id="L140">            log.warn(&quot;Partial or insufficient payment received for reservation {}. Expected {}, Received {}. Keeping status as PENDING_PAYMENT&quot;,</span>
                    reservationId, expectedAmount, amountReceived);
<span class="fc" id="L142">            return;</span>
        }

        // FULL payment received
<span class="fc" id="L146">        log.info(&quot;Full bank payment received for reservation {}. Confirming booking.&quot;, reservationId);</span>
<span class="fc" id="L147">        reservationEvent.setReservationStatus(ReservationStatus.CONFIRMED);</span>
<span class="fc" id="L148">        reservationRepository.save(reservationEvent);</span>
<span class="fc" id="L149">        log.info(&quot;Successfully confirmed reservation {} via bank transfer payment&quot;, reservationId);</span>
<span class="fc" id="L150">    }</span>

    private PaymentVerificationStatus verifyCreditCardPayment(String ref) {
        try {
<span class="fc" id="L154">            PaymentStatusResponse response = creditCardPaymentClient.paymentStatusPost(</span>
                    new PaymentStatusRetrievalRequest(ref));

<span class="pc bpc" id="L157" title="1 of 4 branches missed.">            if (response == null || response.getStatus() == null) {</span>
<span class="fc" id="L158">                log.error(&quot;Null response or status received from credit card payment service for reference: {}&quot;, ref);</span>
<span class="fc" id="L159">                throw new PaymentNotConfirmedException(&quot;Unable to verify payment status&quot;);</span>
            }
<span class="fc" id="L161">            String status = response.getStatus();</span>

<span class="pc bpc" id="L163" title="1 of 4 branches missed.">            return switch (status.toUpperCase()) {</span>
<span class="fc" id="L164">                case &quot;CONFIRMED&quot; -&gt; PaymentVerificationStatus.CONFIRMED;</span>
<span class="fc" id="L165">                case &quot;CANCELLED&quot; -&gt; PaymentVerificationStatus.CANCELLED;</span>
<span class="fc" id="L166">                case &quot;PENDING&quot; -&gt; PaymentVerificationStatus.PENDING;</span>
                default -&gt; {
<span class="nc" id="L168">                    log.warn(&quot;Unknown payment status '{}' received for reference: {}&quot;, status, ref);</span>
<span class="nc" id="L169">                    yield PaymentVerificationStatus.PENDING;</span>
                }
            };

<span class="fc" id="L173">        } catch (FeignException.NotFound ex) {</span>
            // 404 - Payment reference not found
<span class="fc" id="L175">            log.error(&quot;Payment reference not found: {}&quot;, ref);</span>
<span class="fc" id="L176">            return PaymentVerificationStatus.NOT_FOUND;</span>

<span class="fc" id="L178">        } catch (FeignException.BadRequest ex) {</span>
            // 400 - Invalid payment reference format
<span class="fc" id="L180">            log.error(&quot;Invalid payment reference format: {}. Error: {}&quot;, ref, ex.getMessage());</span>
<span class="fc" id="L181">            throw new PaymentReferenceNotFoundException(&quot;Invalid payment reference format: &quot; + ref);</span>

<span class="fc" id="L183">        } catch (FeignException.InternalServerError ex) {</span>
            // 500 - Credit card service internal error
<span class="fc" id="L185">            log.error(&quot;Credit card payment service internal error for reference: {}. Error: {}&quot;, ref, ex.getMessage());</span>
<span class="fc" id="L186">            throw new PaymentNotConfirmedException(&quot;Credit card payment service is currently unavailable. Please try again later.&quot;);</span>

<span class="fc" id="L188">        } catch (FeignException ex) {</span>
            // Generic Feign exception (any other HTTP status)
<span class="fc" id="L190">            log.error(&quot;Unexpected error from credit card payment service for reference: {}. Status: {}, Error: {}&quot;,</span>
<span class="fc" id="L191">                     ref, ex.status(), ex.getMessage());</span>
<span class="fc" id="L192">            throw new PaymentNotConfirmedException(&quot;Unable to verify payment status. Please contact support.&quot;);</span>
        }
    }

    public Reservation getReservation(Long id) {
<span class="fc" id="L197">        return reservationRepository.findById(id)</span>
<span class="fc" id="L198">                .orElseThrow(() -&gt; new ReservationNotFoundException(&quot;Reservation not found for id &quot; + id));</span>
    }

    @Override
    @Transactional
    public int cancelPendingBankTransferReservations() {
<span class="fc" id="L204">        LocalDate cutoffDate = LocalDate.now().plusDays(2);</span>

<span class="fc" id="L206">        log.info(&quot;Cancelling pending bank transfer reservations with start date &lt;= {}&quot;, cutoffDate);</span>
<span class="fc" id="L207">        List&lt;Long&gt; idsToCancel = reservationRepository.findPendingBankTransferIds(cutoffDate);</span>

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (idsToCancel.isEmpty()) {</span>
<span class="nc" id="L210">            log.info(&quot;No pending bank transfer reservations found to cancel&quot;);</span>
<span class="nc" id="L211">            return 0;</span>
        }
<span class="fc" id="L213">        int cancelledCount = reservationRepository.cancelPendingBankTransfers(cutoffDate);</span>
<span class="fc" id="L214">        log.info(&quot;Successfully cancelled {} reservation(s) with IDs: {}&quot;, cancelledCount, idsToCancel);</span>
<span class="fc" id="L215">        return cancelledCount;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>