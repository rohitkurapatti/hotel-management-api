<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankTransferPaymentListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hotel-registration-service</a> &gt; <a href="index.source.html" class="el_package">com.reservation.hotel.kafka</a> &gt; <span class="el_source">BankTransferPaymentListener.java</span></div><h1>BankTransferPaymentListener.java</h1><pre class="source lang-java linenums">package com.reservation.hotel.kafka;

import com.reservation.hotel.dto.BankTransferPaymentEvent;
import com.reservation.hotel.services.ReservationService;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.UUID;

<span class="fc" id="L15">@Slf4j</span>
@Service
@ConditionalOnProperty(
        name = &quot;spring.kafka.enabled&quot;,
        havingValue = &quot;true&quot;
)
public class BankTransferPaymentListener {

    private static final String TRACE_ID_HEADER = &quot;X-Trace-Id&quot;;

    private final ReservationService reservationService;

<span class="fc" id="L27">    public BankTransferPaymentListener(ReservationService reservationService) {</span>
<span class="fc" id="L28">        this.reservationService = reservationService;</span>
<span class="fc" id="L29">    }</span>

    @KafkaListener(
            topics = &quot;bank-transfer-payment-update&quot;,
            groupId = &quot;hotel-reservation-consumer&quot;)
    public void onBankTransferPayment(BankTransferPaymentEvent paymentEvent, @Header(value = TRACE_ID_HEADER, required = false) String traceId) {

        // Set trace-id in MDC (generate if not present)
<span class="pc bpc" id="L37" title="2 of 4 branches missed.">        if (traceId == null || traceId.trim().isEmpty()) {</span>
<span class="nc" id="L38">            traceId = UUID.randomUUID().toString();</span>
<span class="nc" id="L39">            log.debug(&quot;Generated new trace-id for Kafka message: {}&quot;, traceId);</span>
        }
        try {
<span class="fc" id="L42">            MDC.put(&quot;traceId&quot;, traceId);</span>
<span class="fc" id="L43">            log.info(&quot;Received bank transfer payment event: {}&quot;, paymentEvent);</span>
<span class="fc" id="L44">            String txDesc = paymentEvent.getTransactionDescription();</span>

            // Format: &lt;10-char E2E id&gt; &lt;8-char reservationId&gt; e.g. &quot;1401541457 P4145478&quot;
<span class="fc" id="L47">            String[] parts = txDesc.trim().split(&quot;\\s+&quot;);</span>
<span class="pc bpc" id="L48" title="2 of 6 branches missed.">            if (parts.length != 2 || parts[0].length() != 10 || parts[1].length() != 8) {</span>
<span class="fc" id="L49">                log.warn(&quot;Invalid transactionDescription format: {}&quot;, txDesc);</span>
<span class="fc" id="L50">                return;</span>
            }
<span class="fc" id="L52">            String reservationPublicId = parts[1];</span>

            // ReservationPublicId is numeric id string &quot;00000001&quot;.
<span class="fc" id="L55">            Long reservationId = parseReservationId(reservationPublicId);</span>
<span class="fc" id="L56">            BigDecimal amountReceived = paymentEvent.getAmountReceived();</span>

<span class="fc" id="L58">            log.info(&quot;Processing bank transfer payment for reservation ID: {}, amount: {}&quot;, reservationId, amountReceived);</span>
<span class="fc" id="L59">            reservationService.confirmBankTransferPayment(reservationId, amountReceived);</span>

<span class="fc" id="L61">            log.info(&quot;Successfully processed bank transfer payment for reservation ID: {}&quot;, reservationId);</span>
<span class="nc" id="L62">        } catch (Exception ex) {</span>
<span class="nc" id="L63">            log.error(&quot;Error processing bank transfer event for trace-id: {}&quot;, traceId, ex);</span>
        } finally {
            // Clean up MDC
<span class="fc" id="L66">            MDC.clear();</span>
        }
<span class="fc" id="L68">    }</span>

    private Long parseReservationId(String reservationPublicId) {
<span class="fc" id="L71">        return Long.parseLong(reservationPublicId.replaceAll(&quot;\\D&quot;, &quot;&quot;));</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>